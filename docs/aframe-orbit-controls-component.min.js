var PI_2=Math.PI/2;window.AFRAME.registerComponent('orbit-controls',{schema:{enabled:{default:!0}},init:function(){this.previousPosition=new THREE.Vector3,this.deltaPosition=new THREE.Vector3,this.setupMouseControls(),this.setupHMDControls(),this.bindMethods();var a=this.el.getAttribute('target');this.distance=this.el.getAttribute('distance'),this.target3D=document.getElementById(a.replace('#','')).object3D,window.target=this.target3D,window.camera=this.el},update:function(){this.data.enabled&&(this.controls.update(),this.updateOrientation(),this.updatePosition())},play:function(){this.previousPosition.set(0,0,0),this.addEventListeners()},pause:function(){this.removeEventListeners()},tick:function(){this.update()},remove:function(){this.pause()},bindMethods:function(){this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.releaseMouse=this.releaseMouse.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this)},setupMouseControls:function(){this.mouseDown=!1,this.pitchObject=new THREE.Object3D,this.yawObject=new THREE.Object3D,this.yawObject.position.y=10,this.yawObject.add(this.pitchObject)},setupHMDControls:function(){this.dolly=new THREE.Object3D,this.euler=new THREE.Euler,this.controls=new THREE.VRControls(this.dolly),this.zeroQuaternion=new THREE.Quaternion},addEventListeners:function(){var a=this.el.sceneEl,b=a.canvas;return b?void(b.addEventListener('mousedown',this.onMouseDown,!1),b.addEventListener('mousemove',this.onMouseMove,!1),b.addEventListener('mouseup',this.releaseMouse,!1),b.addEventListener('mouseout',this.releaseMouse,!1),b.addEventListener('touchstart',this.onTouchStart),b.addEventListener('touchmove',this.onTouchMove),b.addEventListener('touchend',this.onTouchEnd)):void a.addEventListener('render-target-loaded',this.addEventListeners.bind(this))},removeEventListeners:function(){var a=document.querySelector('a-scene'),b=a&&a.canvas;b&&(b.removeEventListener('mousedown',this.onMouseDown),b.removeEventListener('mousemove',this.onMouseMove),b.removeEventListener('mouseup',this.releaseMouse),b.removeEventListener('mouseout',this.releaseMouse),b.removeEventListener('touchstart',this.onTouchStart),b.removeEventListener('touchmove',this.onTouchMove),b.removeEventListener('touchend',this.onTouchEnd))},updateOrientation:function(){var a=new THREE.Euler;return a.order='YXZ',function(){var b=this.pitchObject,c=this.yawObject,d=this.calculateHMDQuaternion();a.setFromQuaternion(d),this.el.setAttribute('rotation',{x:Math.min(-5,THREE.Math.radToDeg(a.x)+THREE.Math.radToDeg(b.rotation.x)),y:THREE.Math.radToDeg(a.y)+THREE.Math.radToDeg(c.rotation.y),z:THREE.Math.radToDeg(a.z)+THREE.Math.radToDeg(c.rotation.z)})}}(),calculateHMDQuaternion:function(){var a=new THREE.Quaternion;return function(){var b=this.dolly;return this.zeroed||b.quaternion.equals(this.zeroQuaternion)||(this.zeroOrientation(),this.zeroed=!0),a.copy(this.zeroQuaternion).multiply(b.quaternion),a}}(),updatePosition:function(){var a=new THREE.Vector3,b=new THREE.Quaternion,c=new THREE.Vector3;return function(){var d=this.el,f=this.calculateDeltaPosition(),g=this.target3D.position;this.el.object3D.matrixWorld.decompose(a,b,c),f.applyQuaternion(b),d.setAttribute('position',{x:this.target3D.position.x,y:this.target3D.position.y,z:this.target3D.position.z});var h=camera.object3D.translateOnAxis(new THREE.Vector3(0,0,1),this.distance).position;d.setAttribute('position',{x:h.x,y:h.y,z:h.z})}}(),calculateDeltaPosition:function(){var a=this.dolly,b=this.deltaPosition,c=this.previousPosition;return b.copy(a.position),b.sub(c),c.copy(a.position),b},updateHMDQuaternion:function(){var a=new THREE.Quaternion;return function(){var b=this.dolly;return this.controls.update(),this.zeroed||b.quaternion.equals(this.zeroQuaternion)||(this.zeroOrientation(),this.zeroed=!0),a.copy(this.zeroQuaternion).multiply(b.quaternion),a}}(),zeroOrientation:function(){var a=new THREE.Euler;a.setFromQuaternion(this.dolly.quaternion.clone().inverse()),a.z=0,a.x=0,this.zeroQuaternion.setFromEuler(a)},onMouseMove:function(a){var b=this.pitchObject,c=this.yawObject,d=this.previousMouseEvent;if(this.mouseDown&&this.data.enabled){var f=a.movementX||a.mozMovementX,g=a.movementY||a.mozMovementY;(void 0===f||void 0===g)&&(f=a.screenX-d.screenX,g=a.screenY-d.screenY),this.previousMouseEvent=a,c.rotation.y-=2e-3*f,b.rotation.x-=2e-3*g,b.rotation.x=Math.max(-PI_2,Math.min(PI_2,b.rotation.x))}},onMouseDown:function(a){this.mouseDown=!0,this.previousMouseEvent=a},releaseMouse:function(){this.mouseDown=!1},onTouchStart:function(a){1!==a.touches.length||(this.touchStart={x:a.touches[0].pageX,y:a.touches[0].pageY},this.touchStarted=!0)},onTouchMove:function(a){var b,c=this.yawObject;this.touchStarted&&(b=2*Math.PI*(a.touches[0].pageX-this.touchStart.x)/this.el.sceneEl.canvas.clientWidth,c.rotation.y-=0.5*b,this.touchStart={x:a.touches[0].pageX,y:a.touches[0].pageY})},onTouchEnd:function(){this.touchStarted=!1}});